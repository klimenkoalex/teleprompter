<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–¢–µ–ª–µ—Å—É—Ñ–ª—ë—Ä ‚Äî failsafe (—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)</title>
<style>
  :root{ --bg:#000; --fg:#f3f3f3; --muted:#9aa0a6; --accent:#22c55e; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif }
  body{ padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom) }
  .app{ display:flex; flex-direction:column; height:100dvh; gap:.5rem }
  .toolbar{
    position:sticky; top:0; z-index:3; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center;
    padding:.5rem .75rem; background:rgba(18,18,18,.92); backdrop-filter:blur(6px); border-bottom:1px solid #222;
  }
  .toolbar .group{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
  label{ font-size:.9rem; color:var(--muted) }
  input[type="number"]{
    width:5.5rem; padding:.45rem .6rem; border-radius:.6rem; border:1px solid #333; background:#0e0e0e; color:var(--fg);
    font:inherit; -moz-appearance:textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
  button{ font:inherit; background:#111; color:var(--fg); border:1px solid #333; padding:.5rem .75rem; border-radius:.6rem; }
  button.primary{ background:var(--accent); color:#052b13; border-color:#1daa56 }
  .viewer{ position:relative; flex:1; overflow:hidden; border-top:1px solid #222 }
  .mirror{ transform:scaleX(-1) }
  .script{ position:absolute; left:8vw; right:8vw; top:8rem; line-height:1.8; font-size:84px; will-change:transform; transform:translateY(0) }
  .reading .toolbar, .reading .editor{ display:none!important }
  .reading .viewer{ height:100dvh }
  .editor{ padding:.5rem .75rem; background:#0b0b0b; border-top:1px solid #222 }
  textarea{ width:100%; min-height:26dvh; background:#0c0c0c; color:var(--fg); border:1px solid #333; border-radius:.6rem; padding:.75rem; line-height:1.6 }
  .hint{ color:#bbb; font-size:.85rem }
  .pill{ padding:.25rem .5rem; border:1px solid #2a2a2a; border-radius:.5rem; color:#ddd }
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="group">
      <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      <button id="btnPlay" class="primary">–°—Ç–∞—Ä—Ç</button>
      <button id="btnReset">–í –Ω–∞—á–∞–ª–æ</button>
      <button id="btnRead">–ß—Ç–µ–Ω–∏–µ</button>
    </div>
    <div class="group">
      <label>–†–∞–∑–º–µ—Ä (1‚Äì100)
        <input type="number" id="fontVal" min="1" max="100" value="70" inputmode="numeric">
      </label>
      <label>–°–∫–æ—Ä–æ—Å—Ç—å (1‚Äì100)
        <input type="number" id="speedVal" min="1" max="100" value="50" inputmode="numeric">
      </label>
      <label><input type="checkbox" id="chkMirror"> –ó–µ—Ä–∫–∞–ª–æ</label>
    </div>
    <div class="group"><span class="pill" id="status">–ì–æ—Ç–æ–≤–æ</span></div>
  </div>

  <div id="viewer" class="viewer">
    <div id="script" class="script"></div>
  </div>

  <div class="editor">
    <textarea id="src" placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç ‚Üí ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª. –ü–æ—Ç–æ–º ¬´–°—Ç–∞—Ä—Ç¬ª. –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –ø–∞—É–∑—ã."></textarea>
    <div class="hint">–í–≤–æ–¥–∏—à—å —Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è 1‚Äì100: —Ä–∞–∑–º–µ—Ä –∏ —Å–∫–æ—Ä–æ—Å—Ç—å –º—ç–ø–ø—è—Ç—Å—è –≤ –ø–∏–∫—Å–µ–ª–∏. –î–≤–∏–∂–µ–Ω–∏–µ ‚Äî —á–µ—Ä–µ–∑ CSS transform (–ª–µ—Ç–∞–µ—Ç –Ω–∞ iOS).</div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const viewer=$('#viewer'), script=$('#script'), src=$('#src');
  const btnLoad=$('#btnLoad'), btnPlay=$('#btnPlay'), btnReset=$('#btnReset'), btnRead=$('#btnRead');
  const fontVal=$('#fontVal'), speedVal=$('#speedVal'), chkMirror=$('#chkMirror'), statusEl=$('#status');

  // –î–∏–∞–ø–∞–∑–æ–Ω—ã –º—ç–ø–ø–∏–Ω–≥–∞ (–ø—Ä–∞–≤—å –Ω–∞ –≤–∫—É—Å)
  const FONT_MIN=24, FONT_MAX=120;       // px
  const SPEED_MIN=10, SPEED_MAX=300;     // px/s

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  let playing=false, last=0, offset=0, speedPxPerSec=map100(speedVal.value, SPEED_MIN, SPEED_MAX);

  function map100(v, min, max){
    const n = Math.max(1, Math.min(100, Number(v)||1));
    return min + (max - min) * (n - 1) / 99; // —á—Ç–æ–±—ã 1‚Üímin –∏ 100‚Üímax
  }
  function applyFont(){
    const px = Math.round(map100(fontVal.value, FONT_MIN, FONT_MAX));
    script.style.fontSize = px + 'px';
    status('–†–∞–∑–º–µ—Ä: ' + px + 'px');
    localStorage.setItem('tp_font100', String(fontVal.value));
  }
  function applySpeed(){
    speedPxPerSec = map100(speedVal.value, SPEED_MIN, SPEED_MAX);
    status('–°–∫–æ—Ä–æ—Å—Ç—å: ' + Math.round(speedPxPerSec) + ' px/c');
    localStorage.setItem('tp_speed100', String(speedVal.value));
  }

  function render(text){
    script.style.transform='translateY(0)';
    offset=0;
    script.textContent = text || '–î–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç–∞ –ø–æ–±–æ–ª—å—à–µ, —á–µ–º –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω üôÇ';
  }

  function loop(ts){
    if(!playing){ last=0; return; }
    if(!last) last=ts;
    const dt=(ts-last)/1000; last=ts;
    offset += speedPxPerSec * dt;
    script.style.transform = `translateY(${-offset}px)`;
    requestAnimationFrame(loop);
  }

  function status(s){ statusEl.textContent = s; }

  btnLoad.onclick=()=>{
    const t = src.value.trim();
    if(!t){ alert('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ.'); return; }
    render(t);
    localStorage.setItem('tp_script_simple', t);
    status('–¢–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
  };

  btnPlay.onclick=()=>{
    playing=!playing;
    btnPlay.textContent = playing ? '–ü–∞—É–∑–∞' : '–°—Ç–∞—Ä—Ç';
    if(playing){ document.body.classList.add('reading'); requestAnimationFrame(loop); status('–ò–¥—ë—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∞'); }
    else status('–ü–∞—É–∑–∞');
  };

  btnReset.onclick=()=>{
    playing=false; btnPlay.textContent='–°—Ç–∞—Ä—Ç';
    offset=0; script.style.transform='translateY(0)'; status('–í –Ω–∞—á–∞–ª–æ');
  };

  btnRead.onclick=()=> document.body.classList.toggle('reading');

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞ (—Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ –º–µ—Ä–µ –Ω–∞–±–æ—Ä–∞)
  function clampInput(el){
    let v = Number(el.value||'1');
    if(v<1) v=1; if(v>100) v=100;
    el.value = String(Math.round(v));
  }
  fontVal.addEventListener('input', ()=>{ clampInput(fontVal); applyFont(); });
  speedVal.addEventListener('input', ()=>{ clampInput(speedVal); applySpeed(); });
  fontVal.addEventListener('blur', ()=>{ clampInput(fontVal); applyFont(); });
  speedVal.addEventListener('blur', ()=>{ clampInput(speedVal); applySpeed(); });

  chkMirror.onchange=()=> viewer.classList.toggle('mirror', chkMirror.checked);

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
  (function(){
    const savedT = localStorage.getItem('tp_script_simple');
    if(savedT){ src.value=savedT; render(savedT); }
    const f100 = localStorage.getItem('tp_font100'); if(f100){ fontVal.value = f100; }
    const s100 = localStorage.getItem('tp_speed100'); if(s100){ speedVal.value = s100; }
    applyFont(); applySpeed();
    if(!src.value){
      const demo=`–≠—Ç–æ –¥–µ–º–æ failsafe-—Ä–µ–∂–∏–º–∞ —Å –≤–≤–æ–¥–æ–º 1‚Äì100.
–†–∞–∑–º–µ—Ä –∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Ç–æ—á–Ω—ã–µ: 1‚Üí–º–∏–Ω–∏–º—É–º, 100‚Üí–º–∞–∫—Å–∏–º—É–º.
–í—Å—Ç–∞–≤—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª, –∑–∞—Ç–µ–º ¬´–°—Ç–∞—Ä—Ç¬ª.`;
      src.value = demo; render(demo);
    }
  })();
})();
</script>
</body>
</html>
