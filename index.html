<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–¢–µ–ª–µ—Å—É—Ñ–ª–µ—Ä ‚Äî –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
<style>
  :root{
    --bg:#000;
    --fg:#f0f0f0;
    --accent:#22c55e;
    --muted:#999;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  .app{display:flex;flex-direction:column;height:100dvh;gap:.5rem}
  .toolbar{
    position:sticky;top:0;z-index:5;
    display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;
    padding:.5rem .75rem;background:rgba(20,20,20,.85);backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid #222;
  }
  .toolbar .group{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  label{font-size:.9rem;color:var(--muted)}
  input[type="range"]{accent-color:var(--accent)}
  button, select, input[type="checkbox"]{font:inherit}
  button{
    background:#111;border:1px solid #333;color:var(--fg);padding:.5rem .75rem;border-radius:.5rem;
    cursor:pointer;transition:transform .02s ease, background .2s, border-color .2s;
    touch-action:manipulation;
  }
  button:active{transform:scale(.98)}
  button.primary{background:var(--accent);color:#032d14;border-color:#1faa55}
  button.danger{background:#7f1d1d;border-color:#450a0a}
  button[disabled]{opacity:.6;pointer-events:none}
  .toggle{display:inline-flex;gap:.4rem;align-items:center}
  .toggle input{width:1.1rem;height:1.1rem}
  .grow{flex:1}
  .viewer{
    position:relative;flex:1;overflow:auto;scroll-behavior:smooth;
    -webkit-overflow-scrolling:touch;border-top:1px solid #222;
  }
  .mirror{transform:scaleX(-1)}
  .script{
    padding:8rem 8vw; /* —à–∏—Ä–æ–∫–∏–µ –ø–æ–ª—è –¥–ª—è –æ—Ç—Ä–∞–∂–µ–Ω–∏—è –≤ –∑–µ—Ä–∫–∞–ª–µ */
    line-height:1.8;
    font-size:clamp(28px, 6vw, 72px);
    word-break:break-word;
  }
  .script .word{padding:.04em .02em;border-radius:.15em}
  .script .current{background:rgba(34,197,94,.22);outline:2px solid rgba(34,197,94,.55)}
  .marker{
    position:sticky;top:45%;height:0;border-top:2px dashed rgba(255,255,255,.25);z-index:2;margin:0 4vw
  }
  .editor{
    display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;padding:.5rem .75rem;background:#0b0b0b;border-top:1px solid #222
  }
  textarea{
    width:100%;min-height:25dvh;background:#0c0c0c;color:var(--fg);border:1px solid #333;border-radius:.5rem;
    padding:.75rem;font:inherit;line-height:1.6;resize:vertical
  }
  .hint{color:#bbb;font-size:.85rem}
  .pill{padding:.25rem .5rem;border:1px solid #2a2a2a;border-radius:.5rem;color:#ddd}
  .status{color:#ccc}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:.95em}
</style>
</head>
<body>
<div class="app">
  <div class="toolbar" role="toolbar" aria-label="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">
    <div class="group">
      <button id="btnLoad" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ —Å—É—Ñ–ª–µ—Ä">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      <button id="btnPlay" class="primary" title="–°—Ç–∞—Ä—Ç / –ü–∞—É–∑–∞">–°—Ç–∞—Ä—Ç</button>
      <button id="btnReset" title="–°–±—Ä–æ—Å –∫ –Ω–∞—á–∞–ª—É">–í –Ω–∞—á–∞–ª–æ</button>
      <button id="btnFS" title="–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω">‚§¢</button>
    </div>
    <div class="group">
      <label class="toggle"><input type="checkbox" id="chkMirror"> –ó–µ—Ä–∫–∞–ª–æ</label>
      <label class="toggle"><input type="checkbox" id="chkFollowSpeech"> –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–µ—á—å—é</label>
      <label class="toggle"><input type="checkbox" id="chkHighlight"> –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —Å–ª–æ–≤</label>
    </div>
    <div class="group">
      <label>–®—Ä–∏—Ñ—Ç
        <input type="range" id="fontRange" min="24" max="120" value="60">
      </label>
      <label>–°–∫–æ—Ä–æ—Å—Ç—å (px/—Å)
        <input type="range" id="speedRange" min="0" max="200" value="40">
      </label>
    </div>
    <div class="group">
      <label>–†–µ—á—å
        <select id="lang">
          <option value="ru-RU">ru-RU</option>
          <option value="en-US">en-US</option>
        </select>
      </label>
      <button id="btnMic">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>
    <div class="grow"></div>
    <div class="group">
      <span class="pill mono" id="status">–ì–æ—Ç–æ–≤–æ</span>
    </div>
  </div>

  <div id="viewer" class="viewer" tabindex="0">
    <div class="marker" aria-hidden="true"></div>
    <div id="script" class="script" aria-live="polite"></div>
  </div>

  <div class="editor">
    <div class="grow">
      <textarea id="src" placeholder="–í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π —Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª.
–ü–æ–¥—Å–∫–∞–∑–∫–∞: –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –ø–∞—É–∑."></textarea>
      <div class="hint">–ü–æ–¥–¥–µ—Ä–∂–∫–∞: –∫—Ä—É–ø–Ω—ã–π –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π —à—Ä–∏—Ñ—Ç, –∑–µ—Ä–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º, –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ —Å–æ —Å–∫–æ—Ä–æ—Å—Ç—å—é –∏ ¬´—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∑–∞ —Ä–µ—á—å—é¬ª —á–µ—Ä–µ–∑ <span class="mono">SpeechRecognition</span> (–≤ Safari ‚Äî <span class="mono">webkitSpeechRecognition</span>). –ù–∞ iPhone –¥–∞–π —Å–∞–π—Ç—É –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.</div>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const viewer = $('#viewer');
  const scriptEl = $('#script');
  const src = $('#src');
  const btnLoad = $('#btnLoad');
  const btnPlay = $('#btnPlay');
  const btnReset = $('#btnReset');
  const btnFS = $('#btnFS');
  const chkMirror = $('#chkMirror');
  const chkFollowSpeech = $('#chkFollowSpeech');
  const chkHighlight = $('#chkHighlight');
  const fontRange = $('#fontRange');
  const speedRange = $('#speedRange');
  const statusEl = $('#status');
  const langSel = $('#lang');
  const btnMic = $('#btnMic');

  let playing = false;
  let lastTs = 0;
  let rafId = null;
  let currentWord = 0;
  let words = [];           // —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–∞ (–±–µ–∑ –∑–Ω–∞–∫–æ–≤), –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–µ—á–∏
  let spans = [];           // —ç–ª–µ–º–µ–Ω—Ç—ã .word –ø–æ –∏–Ω–¥–µ–∫—Å–∞–º —Å–ª–æ–≤
  let recognition = null;
  let recogOn = false;
  let transcriptTail = [];  // –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å–ª–æ–≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω–æ–π —Ä–µ—á–∏
  const TAIL = 6;
  const MAX_LOOKAHEAD = 60; // —Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –≤–ø–µ—Ä—ë–¥ –∏—â–µ–º —è–∫–æ—Ä—å

  // --- helpers ---
  const norm = (s)=> (s||"")
    .toLowerCase()
    .replaceAll('—ë','–µ')
    .replace(/[^\p{L}\p{N}'‚Äô\- ]+/gu,' ')
    .replace(/\s+/g,' ')
    .trim();

  function splitTokens(text){
    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Ç–æ–∫–µ–Ω—ã: —Å–ª–æ–≤–∞ (–≤–∫–ª. –∫–∏—Ä–∏–ª–ª–∏—Ü—É) –∏ –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—è –ø—Ä–æ–±–µ–ª—ã
    const tokens = [];
    const re = /[\p{L}\p{N}‚Äô'\-]+|[^\s\p{L}\p{N}]/gu;
    let m, i=0;
    while ((m = re.exec(text))){
      // –í—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã, –µ—Å–ª–∏ –µ—Å—Ç—å
      if (m.index > i) tokens.push(text.slice(i, m.index));
      tokens.push(m[0]);
      i = re.lastIndex;
    }
    if (i < text.length) tokens.push(text.slice(i));
    return tokens;
  }

  function renderScript(text){
    scriptEl.innerHTML = '';
    words = [];
    spans = [];
    currentWord = 0;

    const frag = document.createDocumentFragment();
    const tokens = splitTokens(text);
    tokens.forEach(tok=>{
      if (/^[\p{L}\p{N}‚Äô'\-]+$/u.test(tok)){ // —Å–ª–æ–≤–æ
        const span = document.createElement('span');
        span.className = 'word';
        span.textContent = tok;
        spans.push(span);
        words.push(norm(tok));
        frag.appendChild(span);
      } else {
        frag.appendChild(document.createTextNode(tok));
      }
    });
    scriptEl.appendChild(frag);
    updateHighlight();
    scrollToCurrent(false);
    setStatus(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–ª–æ–≤: ${words.length}`);
  }

  function updateHighlight(){
    if (!chkHighlight.checked) {
      spans.forEach(s=>s.classList.remove('current'));
      return;
    }
    spans.forEach((s,i)=> s.classList.toggle('current', i===currentWord));
  }

  function targetYForWord(i){
    const el = spans[i] || scriptEl;
    const rect = el.getBoundingClientRect();
    const vr = viewer.getBoundingClientRect();
    // —Ü–µ–ª–∏–º—Å—è –Ω–µ–º–Ω–æ–≥–æ –Ω–∏–∂–µ —Ü–µ–Ω—Ç—Ä–∞ –ª–∏–Ω–∏–∏-–º–∞—Ä–∫–µ—Ä–∞
    const offset = (vr.height*0.45) - vr.top; // –ø–æ–∑–∏—Ü–∏—è –ª–∏–Ω–∏–∏
    const currentTop = viewer.scrollTop;
    const y = currentTop + rect.top - vr.top - offset - rect.height*0.2;
    return y<0 ? 0 : y;
  }

  function scrollToCurrent(smooth=true){
    const y = targetYForWord(currentWord);
    if (smooth){
      viewer.scrollTo({top:y,behavior:'smooth'});
    } else {
      viewer.scrollTop = y;
    }
  }

  function setStatus(s){ statusEl.textContent = s; }

  // --- play loop (—Ä—É—á–Ω–∞—è –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞) ---
  function loop(ts){
    if (!playing){ rafId=null; return; }
    if (!lastTs) lastTs = ts;
    const dt = (ts - lastTs) / 1000;
    lastTs = ts;
    const pxps = Number(speedRange.value);
    if (!chkFollowSpeech.checked && pxps>0){
      viewer.scrollTop += pxps * dt;
    }
    rafId = requestAnimationFrame(loop);
  }

  function start(){
    if (playing) return;
    playing = true;
    btnPlay.textContent = '–ü–∞—É–∑–∞';
    lastTs = 0;
    rafId = requestAnimationFrame(loop);
    setStatus('–ò–¥—ë—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∞');
  }

  function pause(){
    playing = false;
    btnPlay.textContent = '–°—Ç–∞—Ä—Ç';
    if (rafId) cancelAnimationFrame(rafId);
    rafId = null;
    setStatus('–ü–∞—É–∑–∞');
  }

  function resetToStart(){
    currentWord = 0;
    updateHighlight();
    scrollToCurrent(false);
  }

  // --- speech recognition ---
  function initRecognition(){
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR){
      setStatus('SpeechRecognition –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
      btnMic.disabled = true;
      return null;
    }
    const r = new SR();
    r.continuous = true;
    r.interimResults = true;
    r.lang = langSel.value;
    r.onresult = (ev)=>{
      let finalChunk = '';
      for (let i=ev.resultIndex;i<ev.results.length;i++){
        const res = ev.results[i];
        const text = res[0].transcript;
        if (res.isFinal) finalChunk += ' ' + text;
      }
      if (finalChunk){
        processTranscript(finalChunk);
      }
    };
    r.onend = ()=>{
      if (recogOn){
        try { r.start(); } catch(e){ /* safari resume guard */ }
      }
    };
    r.onerror = (e)=> setStatus('–û—à–∏–±–∫–∞ —Ä–µ—á–∏: ' + (e.error||'unknown'));
    return r;
  }

  function processTranscript(text){
    // –æ–±–Ω–æ–≤–ª—è–µ–º ¬´—Ö–≤–æ—Å—Ç¬ª –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–ª–æ–≤ –∏ –ø—Ä–æ–±—É–µ–º —Å–æ—Å—Ç—ã–∫–æ–≤–∞—Ç—å —Å–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–º
    const toks = norm(text).split(' ').filter(Boolean);
    transcriptTail.push(...toks);
    if (transcriptTail.length>TAIL) transcriptTail = transcriptTail.slice(-TAIL);

    // –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –¥–ª–∏–Ω–Ω—ã–π —è–∫–æ—Ä—å –æ—Ç 5 –∫ 2 —Å–ª–æ–≤–∞–º
    for (let k=Math.min(TAIL,5); k>=2; k--){
      const sub = transcriptTail.slice(-k);
      const pos = findSubseq(words, sub, currentWord, MAX_LOOKAHEAD);
      if (pos>=0){
        currentWord = pos + k;
        updateHighlight();
        scrollToCurrent(true);
        setStatus('–°–∏–Ω—Ö—Ä–æ–Ω —Å–æ —Ä–µ—á—å—é ‚úì');
        return;
      }
    }
    // fallback: –æ–¥–∏–Ω–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ –≤–ø–µ—Ä—ë–¥
    const last = transcriptTail[transcriptTail.length-1];
    if (last){
      for (let i=currentWord;i<Math.min(words.length,currentWord+10);i++){
        if (words[i]===last){
          currentWord = i+1;
          updateHighlight();
          scrollToCurrent(true);
          setStatus('–°–∏–Ω—Ö—Ä–æ–Ω –ø–æ —Å–ª–æ–≤—É ‚úì');
          return;
        }
      }
    }
  }

  function findSubseq(arr, sub, start, lookahead){
    const end = Math.min(arr.length - sub.length, start + lookahead);
    const needle = sub.join(' ');
    for (let i=start;i<=end;i++){
      // –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ–ø—É—Å–∫: –ø–µ—Ä–≤–æ–µ —Å–ª–æ–≤–æ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞—Å—Ç—å
      if (arr[i]!==sub[0]) continue;
      // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –æ–∫–Ω–æ
      let ok = true;
      for (let j=1;j<sub.length;j++){
        if (arr[i+j]!==sub[j]) { ok=false; break; }
      }
      if (ok) return i;
    }
    return -1;
  }

  function toggleMic(){
    if (!recognition){
      recognition = initRecognition();
      if (!recognition) return;
    }
    if (!recogOn){
      try {
        recognition.lang = langSel.value;
        recognition.start();
        recogOn = true;
        btnMic.classList.add('primary');
        setStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω');
      } catch(e){
        setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ');
      }
    } else {
      try{ recognition.stop(); }catch(e){}
      recogOn = false;
      btnMic.classList.remove('primary');
      setStatus('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
    }
  }

  // --- events ---
  btnLoad.addEventListener('click', ()=>{
    const text = src.value.trim();
    if (!text){ alert('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –≤ –ø–æ–ª–µ –Ω–∏–∂–µ.'); return; }
    renderScript(text);
    localStorage.setItem('tp_script', text);
  });

  btnPlay.addEventListener('click', ()=> playing ? pause() : start());
  btnReset.addEventListener('click', resetToStart);
  btnFS.addEventListener('click', ()=>{
    const el = document.documentElement;
    if (!document.fullscreenElement){
      el.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });
  chkMirror.addEventListener('change', ()=>{
    viewer.classList.toggle('mirror', chkMirror.checked);
    localStorage.setItem('tp_mirror', chkMirror.checked ? '1':'0');
  });
  chkFollowSpeech.addEventListener('change', ()=>{
    localStorage.setItem('tp_follow', chkFollowSpeech.checked ? '1':'0');
  });
  chkHighlight.addEventListener('change', updateHighlight);
  fontRange.addEventListener('input', ()=>{
    scriptEl.style.fontSize = fontRange.value + 'px';
    localStorage.setItem('tp_font', fontRange.value);
  });
  speedRange.addEventListener('input', ()=>{
    localStorage.setItem('tp_speed', speedRange.value);
  });
  btnMic.addEventListener('click', toggleMic);
  langSel.addEventListener('change', ()=>{
    localStorage.setItem('tp_lang', langSel.value);
    if (recognition && recogOn){
      recognition.stop(); // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å –Ω–æ–≤—ã–º —è–∑—ã–∫–æ–º
      setTimeout(()=>{ try{ recognition.start(); }catch(e){} }, 150);
    }
  });

  viewer.addEventListener('click', ()=> playing ? pause() : start());
  viewer.addEventListener('keydown', (e)=>{
    if (e.code==='Space'){ e.preventDefault(); playing ? pause() : start(); }
    if (e.code==='ArrowRight'){ currentWord = Math.min(currentWord+1, words.length-1); updateHighlight(); scrollToCurrent(true); }
    if (e.code==='ArrowLeft'){ currentWord = Math.max(currentWord-1, 0); updateHighlight(); scrollToCurrent(true); }
  });

  // --- restore state ---
  (function restore(){
    const saved = localStorage.getItem('tp_script');
    if (saved){ src.value = saved; renderScript(saved); }
    const font = localStorage.getItem('tp_font'); if (font){ fontRange.value = font; scriptEl.style.fontSize = font+'px'; }
    const speed = localStorage.getItem('tp_speed'); if (speed){ speedRange.value = speed; }
    const mir = localStorage.getItem('tp_mirror')==='1'; chkMirror.checked = mir; viewer.classList.toggle('mirror', mir);
    const follow = localStorage.getItem('tp_follow')==='1'; chkFollowSpeech.checked = follow;
    const lang = localStorage.getItem('tp_lang'); if (lang){ langSel.value = lang; }
    chkHighlight.checked = true;
  })();

  // –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ)
  if (!src.value){
    src.value = `–≠—Ç–æ –¥–µ–º–æ –≤–µ–±-—Å—É—Ñ–ª–µ—Ä–∞. –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª. 
–í–∫–ª—é—á–∏ ¬´–ó–µ—Ä–∫–∞–ª–æ¬ª, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –∑–µ—Ä–∫–∞–ª—å–Ω—É—é –ø–ª–∞—Å—Ç–∏–Ω—É. 
–ù–∞–∂–º–∏ üé§ ¬´–ú–∏–∫—Ä–æ—Ñ–æ–Ω¬ª ‚Äî –∏ —Å—É—Ñ–ª–µ—Ä –±—É–¥–µ—Ç –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –ø–æ–¥ —Ç–≤–æ—é —Ä–µ—á—å.`;
    renderScript(src.value);
  }

})();
</script>
</body>
</html>
