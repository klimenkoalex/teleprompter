<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–¢–µ–ª–µ—Å—É—Ñ–ª—ë—Ä ‚Äî failsafe + mic (—Ñ–∏–∫—Å –≤–≤–æ–¥–∞)</title>
<style>
  :root{ --bg:#000; --fg:#f3f3f3; --muted:#9aa0a6; --accent:#22c55e; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif }
  body{ padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom) }
  .app{ display:flex; flex-direction:column; height:100dvh; gap:.5rem }
  .toolbar{
    position:sticky; top:0; z-index:3; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center;
    padding:.5rem .75rem; background:rgba(18,18,18,.92); backdrop-filter:blur(6px); border-bottom:1px solid #222;
  }
  .toolbar .group{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
  label{ font-size:.9rem; color:var(--muted) }
  input[type="number"]{
    width:5.5rem; padding:.45rem .6rem; border-radius:.6rem; border:1px solid #333; background:#0e0e0e; color:var(--fg);
    font:inherit; -moz-appearance:textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  button{ font:inherit; background:#111; color:#fff; border:1px solid #333; padding:.5rem .75rem; border-radius:.6rem; }
  button.primary{ background:var(--accent); color:#052b13; border-color:#1daa56 }
  button[disabled]{ opacity:.6; pointer-events:none }
  .viewer{ position:relative; flex:1; overflow:hidden; border-top:1px solid #222 }
  .mirror{ transform:scaleX(-1) }
  .script{ position:absolute; left:8vw; right:8vw; top:8rem; line-height:1.8; font-size:84px; will-change:transform; transform:translateY(0) }
  .word{ padding:.04em .02em; border-radius:.15em }
  .current{ background:rgba(34,197,94,.22); outline:2px solid rgba(34,197,94,.55) }
  .reading .toolbar, .reading .editor{ display:none!important }
  .reading .viewer{ height:100dvh }
  .editor{ padding:.5rem .75rem; background:#0b0b0b; border-top:1px solid #222 }
  textarea{ width:100%; min-height:26dvh; background:#0c0c0c; color:var(--fg); border:1px solid #333; border-radius:.6rem; padding:.75rem; line-height:1.6 }
  .hint{ color:#bbb; font-size:.85rem }
  .pill{ padding:.25rem .5rem; border:1px solid #2a2a2a; border-radius:.6rem; color:#ddd }
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="group">
      <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      <button id="btnPlay" class="primary">–°—Ç–∞—Ä—Ç</button>
      <button id="btnReset">–í –Ω–∞—á–∞–ª–æ</button>
      <button id="btnRead">–ß—Ç–µ–Ω–∏–µ</button>
    </div>
    <div class="group">
      <label>–†–∞–∑–º–µ—Ä (1‚Äì100) <input type="number" id="fontVal" min="1" max="100" value="70" inputmode="numeric" placeholder="1‚Äì100"></label>
      <label>–°–∫–æ—Ä–æ—Å—Ç—å (1‚Äì100) <input type="number" id="speedVal" min="1" max="100" value="50" inputmode="numeric" placeholder="1‚Äì100"></label>
      <label><input type="checkbox" id="chkMirror"> –ó–µ—Ä–∫–∞–ª–æ</label>
      <label><input type="checkbox" id="chkFollow"> –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–µ—á—å—é</label>
      <button id="btnMic">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>
    <div class="group"><span class="pill" id="status">–ì–æ—Ç–æ–≤–æ</span></div>
  </div>

  <div id="viewer" class="viewer">
    <div id="script" class="script"></div>
  </div>

  <div class="editor">
    <textarea id="src" placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç ‚Üí ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª. –ü–æ—Ç–æ–º ¬´–°—Ç–∞—Ä—Ç¬ª. –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –ø–∞—É–∑—ã."></textarea>
    <div class="hint">üé§ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ Safari (iOS). –í Chrome iOS ‚Äî —Ç–æ–ª—å–∫–æ –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏.</div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const viewer=$('#viewer'), script=$('#script'), src=$('#src');
  const btnLoad=$('#btnLoad'), btnPlay=$('#btnPlay'), btnReset=$('#btnReset'), btnRead=$('#btnRead');
  const fontVal=$('#fontVal'), speedVal=$('#speedVal'), chkMirror=$('#chkMirror'), chkFollow=$('#chkFollow');
  const statusEl=$('#status'), btnMic=$('#btnMic');

  // –î–∏–∞–ø–∞–∑–æ–Ω—ã –º–∞–ø–ø–∏–Ω–≥–∞ 1..100
  const FONT_MIN=24, FONT_MAX=120;      // px
  const SPEED_MIN=10, SPEED_MAX=300;    // px/s

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  let playing=false, last=0, offset=0;
  let words=[], spans=[], currentWord=0;
  let recognition=null, recogOn=false, tail=[];
  let lastFont100=70, lastSpeed100=50; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∞–ª–∏–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è 1..100
  const TAIL=6, LOOKAHEAD=60;

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  if(!SR){ btnMic.disabled=true; note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ'); }

  function map100(n, min, max){ return min + (max - min) * (n - 1) / 99; }

  // ----- —Ç–µ–∫—Å—Ç –∏ –¥–≤–∏–∂–µ–Ω–∏–µ (translateY) -----
  function render(text){
    script.style.transform='translateY(0)'; offset=0; currentWord=0;
    words=[]; spans=[]; script.innerHTML='';
    const toks = splitTokens(text || '–î–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç–∞ –ø–æ–±–æ–ª—å—à–µ, —á–µ–º –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω üôÇ');
    const frag=document.createDocumentFragment();
    toks.forEach(tok=>{
      if(/^[\p{L}\p{N}‚Äô'\-]+$/u.test(tok)){
        const span=document.createElement('span'); span.className='word'; span.textContent=tok;
        spans.push(span); words.push(norm(tok)); frag.appendChild(span);
      } else frag.appendChild(document.createTextNode(tok));
    });
    script.appendChild(frag); highlight();
  }
  function loop(ts){
    if(!playing){ last=0; return; }
    if(!last) last=ts;
    const dt=(ts-last)/1000; last=ts;
    // –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ —Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω ‚Äî –Ω–µ –¥–≤–∏–≥–∞–µ–º —Å–∞–º–∏
    if(!(chkFollow.checked && recogOn)){
      const speedPxPerSec = map100(lastSpeed100, SPEED_MIN, SPEED_MAX);
      offset += speedPxPerSec * dt;
      applyOffset();
    }
    requestAnimationFrame(loop);
  }
  function applyOffset(){ script.style.transform = `translateY(${-offset}px)`; }

  // ----- –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ —è–∫–æ—Ä–µ–Ω–∏–µ –ø–æ —Ä–µ—á–∏ -----
  function highlight(){ spans.forEach((s,i)=> s.classList.toggle('current', i===currentWord)); }
  function scrollToWord(i){
    i=Math.max(0, Math.min(i, spans.length-1)); currentWord=i; highlight();
    const vr=viewer.getBoundingClientRect(); const rect=spans[i].getBoundingClientRect();
    const target = vr.top + vr.height*0.45;
    const delta = rect.top - target;
    offset += delta; applyOffset();
  }
  function initSR(){
    if(!SR) return null;
    const r=new SR(); r.continuous=true; r.interimResults=true; r.lang='ru-RU';
    r.onresult=(ev)=>{
      let final=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const res=ev.results[i]; if(res.isFinal) final+=' '+res[0].transcript; }
      if(final) handleTranscript(final);
    };
    r.onend=()=>{ if(recogOn){ try{ r.start(); }catch(e){} } };
    r.onerror=(e)=> note('–û—à–∏–±–∫–∞ —Ä–µ—á–∏: '+(e.error||'unknown'));
    return r;
  }
  function handleTranscript(text){
    const toks=norm(text).split(' ').filter(Boolean);
    tail.push(...toks); if(tail.length>TAIL) tail=tail.slice(-TAIL);
    for(let k=Math.min(TAIL,5); k>=2; k--){
      const sub = tail.slice(-k);
      const pos = findSubseq(words, sub, currentWord, LOOKAHEAD);
      if(pos>=0){ scrollToWord(pos+k); note('–°–∏–Ω—Ö—Ä–æ–Ω ‚úì'); return; }
    }
    const last = tail[tail.length-1];
    if(last){ for(let i=currentWord; i<Math.min(words.length, currentWord+10); i++){ if(words[i]===last){ scrollToWord(i+1); note('–°–∏–Ω—Ö—Ä–æ–Ω –ø–æ —Å–ª–æ–≤—É ‚úì'); return; } } }
  }
  function findSubseq(arr, sub, start, lookahead){
    const end=Math.min(arr.length - sub.length, start + lookahead);
    for(let i=start;i<=end;i++){ if(arr[i]!==sub[0]) continue; let ok=true; for(let j=1;j<sub.length;j++){ if(arr[i+j]!==sub[j]){ ok=false; break; } } if(ok) return i; }
    return -1;
  }

  // ----- —É—Ç–∏–ª–∏—Ç—ã -----
  function splitTokens(text){
    const tokens=[]; const re=/[\p{L}\p{N}‚Äô'\-]+|[^\s\p{L}\p{N}]/gu; let m,i=0;
    while(m=re.exec(text)){ if(m.index>i) tokens.push(text.slice(i,m.index)); tokens.push(m[0]); i=re.lastIndex }
    if(i<text.length) tokens.push(text.slice(i)); return tokens;
  }
  const norm = s => (s||"").toLowerCase().replaceAll('—ë','–µ').replace(/[^\p{L}\p{N}'‚Äô\- ]+/gu,' ').replace(/\s+/g,' ').trim();
  function note(s){ statusEl.textContent=s; }

  // ----- —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -----
  btnLoad.onclick=()=>{
    const t = src.value.trim();
    if(!t){ alert('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ.'); return; }
    render(t);
    localStorage.setItem('tp_script_simple', t);
    note('–¢–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω');
  };
  btnPlay.onclick=()=>{ playing = !playing; btnPlay.textContent = playing ? '–ü–∞—É–∑–∞' : '–°—Ç–∞—Ä—Ç'; if(playing){ document.body.classList.add('reading'); requestAnimationFrame(loop); note('–ò–¥—ë—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∞'); } else note('–ü–∞—É–∑–∞'); };
  btnReset.onclick=()=>{ playing=false; btnPlay.textContent='–°—Ç–∞—Ä—Ç'; offset=0; applyOffset(); currentWord=0; highlight(); note('–í –Ω–∞—á–∞–ª–æ'); };
  btnRead.onclick=()=> document.body.classList.toggle('reading');
  chkMirror.onchange=()=> viewer.classList.toggle('mirror', chkMirror.checked);

  // –í–í–û–î 1‚Äì100 –ë–ï–ó –°–ê–ú–û–°–†–ê–ë–ê–¢–´–í–ê–Æ–©–ï–ô –ó–ê–ñ–ò–ú–ö–ò:
  // ‚Äî –º–æ–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ (''), —Ü–∏—Ñ—Ä—ã –≤–≤–æ–¥—è—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω–æ;
  // ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤–≤–µ–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω–æ–µ 1..100;
  // ‚Äî –Ω–∞ blur –ø—É—Å—Ç–æ–µ –ø–æ–ª–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º –∫ –ø—Ä–æ—à–ª–æ–º—É –≤–∞–ª–∏–¥–Ω–æ–º—É.
  function onFontInput(){
    const raw = fontVal.value.trim();
    if(raw===''){ note('–†–∞–∑–º–µ—Ä: ‚Ä¶'); return; }              // –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—É—Å—Ç–æ ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º
    const n = Number(raw);
    if(Number.isInteger(n) && n>=1 && n<=100){
      lastFont100 = n;
      script.style.fontSize = Math.round(map100(lastFont100, FONT_MIN, FONT_MAX)) + 'px';
      localStorage.setItem('tp_font100', String(lastFont100));
      note('–†–∞–∑–º–µ—Ä: ' + lastFont100 + ' (–ø—Ä–∏–º–µ–Ω—ë–Ω)');
    } // –∏–Ω–∞—á–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–≤–æ–¥–∞
  }
  function onFontBlur(){
    let raw = fontVal.value.trim();
    if(raw===''){ fontVal.value = String(lastFont100); onFontInput(); return; }
    let n = Number(raw);
    if(!Number.isInteger(n)) n = lastFont100;
    if(n<1) n=1; if(n>100) n=100;
    fontVal.value = String(n);
    onFontInput();
  }
  function onSpeedInput(){
    const raw = speedVal.value.trim();
    if(raw===''){ note('–°–∫–æ—Ä–æ—Å—Ç—å: ‚Ä¶'); return; }
    const n = Number(raw);
    if(Number.isInteger(n) && n>=1 && n<=100){
      lastSpeed100 = n;
      localStorage.setItem('tp_speed100', String(lastSpeed100));
      note('–°–∫–æ—Ä–æ—Å—Ç—å: ' + lastSpeed100 + ' (–ø—Ä–∏–º–µ–Ω–µ–Ω–∞)');
    }
  }
  function onSpeedBlur(){
    let raw = speedVal.value.trim();
    if(raw===''){ speedVal.value = String(lastSpeed100); onSpeedInput(); return; }
    let n = Number(raw);
    if(!Number.isInteger(n)) n = lastSpeed100;
    if(n<1) n=1; if(n>100) n=100;
    speedVal.value = String(n);
    onSpeedInput();
  }
  fontVal.addEventListener('input', onFontInput);
  fontVal.addEventListener('blur', onFontBlur);
  speedVal.addEventListener('input', onSpeedInput);
  speedVal.addEventListener('blur', onSpeedBlur);

  btnMic.onclick=()=>{
    if(!SR){ note('–í —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ SR –Ω–µ—Ç'); return; }
    if(!recognition) recognition = initSR();
    if(!recogOn){
      try{ recognition.start(); recogOn=true; btnMic.classList.add('primary'); note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω'); }
      catch(e){ note('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ'); }
    } else {
      try{ recognition.stop(); }catch(e){}
      recogOn=false; btnMic.classList.remove('primary'); note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
    }
  };

  // ----- –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ -----
  (function(){
    const savedT=localStorage.getItem('tp_script_simple'); if(savedT){ src.value=savedT; render(savedT); }
    const f100=Number(localStorage.getItem('tp_font100')); if(Number.isInteger(f100) && f100>=1 && f100<=100){ lastFont100=f100; }
    const s100=Number(localStorage.getItem('tp_speed100')); if(Number.isInteger(s100) && s100>=1 && s100<=100){ lastSpeed100=s100; }
    fontVal.value = String(lastFont100); speedVal.value = String(lastSpeed100);
    // –ø—Ä–∏–º–µ–Ω—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ
    script.style.fontSize = Math.round(map100(lastFont100, FONT_MIN, FONT_MAX)) + 'px';
    note('–ì–æ—Ç–æ–≤–æ');
    if(!src.value){
      const demo=`–≠—Ç–æ –¥–µ–º–æ —Ä–µ–∂–∏–º–∞ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–º (—Ç–æ–ª—å–∫–æ Safari –Ω–∞ iOS). –í Chrome iOS —Ä–µ—á–∏ –Ω–µ—Ç ‚Äî –∞–≤—Ç–æ–ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–æ —Å–∫–æ—Ä–æ—Å—Ç–∏.
–í—Å—Ç–∞–≤—å –¥–ª–∏–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª, –∑–∞—Ç–µ–º ¬´–°—Ç–∞—Ä—Ç¬ª.
–†–∞–∑–º–µ—Ä/—Å–∫–æ—Ä–æ—Å—Ç—å –≤–≤–æ–¥–∏ 1‚Äì100: –ø–æ–ª–µ –º–æ–∂–Ω–æ –æ—á–∏—â–∞—Ç—å, —á–∏—Å–ª–∞ –∏–∑ –¥–≤—É—Ö/—Ç—Ä—ë—Ö —Ü–∏—Ñ—Ä –≤–≤–æ–¥—è—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ.`;
      src.value=demo; render(demo);
    }
  })();
})();
</script>
</body>
</html>
