<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>–¢–µ–ª–µ—Å—É—Ñ–ª—ë—Ä ‚Äî VAD –≤–µ–∑–¥–µ, SR –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ</title>
<style>
  :root{ --bg:#000; --fg:#f3f3f3; --muted:#9aa0a6; --accent:#22c55e; }
  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif }
  body{ padding-top:env(safe-area-inset-top); padding-bottom:env(safe-area-inset-bottom) }
  .app{ display:flex; flex-direction:column; height:100dvh; gap:.5rem }
  .toolbar{
    position:sticky; top:0; z-index:3; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center;
    padding:.5rem .75rem; background:rgba(18,18,18,.92); backdrop-filter:blur(6px); border-bottom:1px solid #222;
  }
  .toolbar .group{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }
  label{ font-size:.9rem; color:var(--muted) }
  input[type="number"]{
    width:5.5rem; padding:.45rem .6rem; border-radius:.6rem; border:1px solid #333; background:#0e0e0e; color:#fff;
    font:inherit; -moz-appearance:textfield;
  }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  select{
    background:#0e0e0e; color:#fff; border:1px solid #333; border-radius:.6rem; padding:.45rem .6rem; font:inherit;
  }
  button{ font:inherit; background:#111; color:#fff; border:1px solid #333; padding:.5rem .75rem; border-radius:.6rem; }
  button.primary{ background:var(--accent); color:#052b13; border-color:#1daa56 }
  button[disabled]{ opacity:.6; pointer-events:none }
  .pill{ padding:.25rem .5rem; border:1px solid #2a2a2a; border-radius:.6rem; color:#ddd }
  .viewer{ position:relative; flex:1; overflow:hidden; border-top:1px solid #222 }
  .mirror{ transform:scaleX(-1) }
  .script{
    position:absolute; left:8vw; right:8vw; top:8rem;
    line-height:1.8; font-size:84px; will-change:transform; transform:translateY(0);

    /* –ø–µ—Ä–µ–Ω–æ—Å—ã –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ */
    white-space: pre-wrap;       /* —Å–æ—Ö—Ä–∞–Ω—è–µ–º \n, –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º */
    overflow-wrap: anywhere;     /* –¥–ª–∏–Ω–Ω—ã–µ —Å–ª–æ–≤–∞/URL –ø–µ—Ä–µ–Ω–æ—Å–∏–º –≥–¥–µ —É–≥–æ–¥–Ω–æ */
    word-break: normal;          /* –Ω–µ —Ä—É–±–∏–º —Å–ª–æ–≤–∞ –∂–µ—Å—Ç–∫–æ */
    -webkit-hyphens: auto; hyphens: auto; /* –¥–µ—Ñ–∏—Å—ã —Ç–∞–º, –≥–¥–µ –µ—Å—Ç—å —Å–ª–æ–≤–∞—Ä—å */
  }
  .word{ padding:.04em .02em; border-radius:.15em }
  .current{ background:rgba(34,197,94,.22); outline:2px solid rgba(34,197,94,.55) }
  .reading .toolbar, .reading .editor{ display:none!important }
  .reading .viewer{ height:100dvh }
  .editor{ padding:.5rem .75rem; background:#0b0b0b; border-top:1px solid #222 }
  textarea{ width:100%; min-height:26dvh; background:#0c0c0c; color:#fff; border:1px solid #333; border-radius:.6rem; padding:.75rem; line-height:1.6 }
  .hint{ color:#bbb; font-size:.85rem }
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <div class="group">
      <button id="btnLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
      <button id="btnPlay" class="primary">–°—Ç–∞—Ä—Ç</button>
      <button id="btnReset">–í –Ω–∞—á–∞–ª–æ</button>
      <button id="btnRead">–ß—Ç–µ–Ω–∏–µ</button>
    </div>
    <div class="group">
      <label>–†–∞–∑–º–µ—Ä (1‚Äì100) <input type="number" id="fontVal" min="1" max="100" value="70" inputmode="numeric" placeholder="1‚Äì100"></label>
      <label>–°–∫–æ—Ä–æ—Å—Ç—å (1‚Äì100) <input type="number" id="speedVal" min="1" max="100" value="50" inputmode="numeric" placeholder="1‚Äì100"></label>
      <label><input type="checkbox" id="chkMirror"> –ó–µ—Ä–∫–∞–ª–æ</label>
    </div>
    <div class="group">
      <label title="–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞">
        –ú–∏–∫—Ä–æ-—Ä–µ–∂–∏–º
        <select id="micMode">
          <option value="vad">–ü–æ –≥–æ–ª–æ—Å—É (VAD)</option>
          <option value="sr">–ü–æ —Å–ª–æ–≤–∞–º (SR)</option>
        </select>
      </label>
      <label title="–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å/–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞">
        <input type="checkbox" id="chkFollow"> –°–ª–µ–¥–∏—Ç—å –ø–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
      </label>
      <button id="btnMic">üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
    </div>
    <div class="group"><span class="pill" id="status">–ì–æ—Ç–æ–≤–æ</span></div>
  </div>

  <div id="viewer" class="viewer">
    <div id="script" class="script"></div>
  </div>

  <div class="editor">
    <textarea id="src" placeholder="–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç ‚Üí ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—Å—Ç¬ª. –ü–æ—Ç–æ–º ¬´–°—Ç–∞—Ä—Ç¬ª. –ü—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –ø–∞—É–∑—ã."></textarea>
    <div class="hint">VAD —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –≤ Safari, –∏ –≤ Chrome. SR (–ø–æ —Å–ª–æ–≤–∞–º) ‚Äî —Ç–æ–ª—å–∫–æ —Ç–∞–º, –≥–¥–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition.</div>
  </div>
</div>

<script>
(function(){
  const $=s=>document.querySelector(s);
  const viewer=$('#viewer'), script=$('#script'), src=$('#src');
  const btnLoad=$('#btnLoad'), btnPlay=$('#btnPlay'), btnReset=$('#btnReset'), btnRead=$('#btnRead');
  const fontVal=$('#fontVal'), speedVal=$('#speedVal'), chkMirror=$('#chkMirror');
  const chkFollow=$('#chkFollow'), micModeSel=$('#micMode');
  const statusEl=$('#status'), btnMic=$('#btnMic');

  // –î–∏–∞–ø–∞–∑–æ–Ω—ã 1..100
  const FONT_MIN=24, FONT_MAX=120;     // px
  const SPEED_MIN=10, SPEED_MAX=300;   // px/s

  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  let playing=false, last=0, offset=0;
  let words=[], spans=[], currentWord=0;
  let lastFont100=70, lastSpeed100=50;

  // SR –∏ VAD
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition || null;
  const supportsVAD = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia && (window.AudioContext||window.webkitAudioContext));
  let micMode='vad'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é VAD
  let recognition=null, recogOn=false, tail=[];
  const TAIL=6, LOOKAHEAD=60;

  let audioCtx=null, mediaStream=null, analyser=null, vadOn=false, voiceActive=false, vadRaf=null;
  const VAD_ON=0.025, VAD_OFF=0.015; // RMS –ø–æ—Ä–æ–≥–∏

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ —Ä–µ–∂–∏–º–∞
  (function initMicMode(){
    if(!SR){ micModeSel.querySelector('option[value="sr"]').disabled = true; }
    if(!supportsVAD){ micModeSel.querySelector('option[value="vad"]').disabled = true; }
    if(!supportsVAD && SR) micMode='sr';
    micModeSel.value = micMode;
    micModeSel.addEventListener('change', ()=>{
      const next = micModeSel.value;
      stopAllMic();
      micMode = next;
      note('–†–µ–∂–∏–º –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + (micMode==='vad'?'VAD':'SR'));
    });
  })();

  function note(s){ statusEl.textContent=s; }
  function map100(n,min,max){ return min + (max - min) * (n - 1) / 99; }
  const norm = s => (s||"").toLowerCase().replaceAll('—ë','–µ').replace(/[^\p{L}\p{N}'‚Äô\- ]+/gu,' ').replace(/\s+/g,' ').trim();

  // –†–µ–Ω–¥–µ—Ä —Ç–µ–∫—Å—Ç–∞ —Å –æ–±—ë—Ä—Ç–∫–æ–π —Å–ª–æ–≤ (–¥–ª—è SR)
  function splitTokens(text){
    const tokens=[]; const re=/[\p{L}\p{N}‚Äô'\-]+|[^\s\p{L}\p{N}]/gu; let m,i=0;
    while(m=re.exec(text)){ if(m.index>i) tokens.push(text.slice(i,m.index)); tokens.push(m[0]); i=re.lastIndex }
    if(i<text.length) tokens.push(text.slice(i)); return tokens;
  }
  function render(text){
    script.style.transform='translateY(0)'; offset=0; currentWord=0;
    words=[]; spans=[]; script.innerHTML='';
    const toks=splitTokens(text || '–î–æ–±–∞–≤—å —Ç–µ–∫—Å—Ç–∞ –ø–æ–±–æ–ª—å—à–µ, —á–µ–º –æ–¥–∏–Ω —ç–∫—Ä–∞–Ω üôÇ');
    const frag=document.createDocumentFragment();
    toks.forEach(tok=>{
      if(/^[\p{L}\p{N}‚Äô'\-]+$/u.test(tok)){
        const span=document.createElement('span'); span.className='word'; span.textContent=tok;
        spans.push(span); words.push(norm(tok)); frag.appendChild(span);
      } else frag.appendChild(document.createTextNode(tok));
    });
    script.appendChild(frag); highlight();
  }
  function highlight(){ spans.forEach((s,i)=> s.classList.toggle('current', i===currentWord)); }

  // –ì–ª–∞–≤–Ω—ã–π —Ü–∏–∫–ª (translateY)
  function loop(ts){
    if(!playing){ last=0; return; }
    if(!last) last=ts;
    const dt=(ts-last)/1000; last=ts;

    const follow = chkFollow.checked;
    const speedPxPerSec = map100(lastSpeed100, SPEED_MIN, SPEED_MAX);

    let gate=1;
    if(follow){
      if(micMode==='sr' && recogOn) gate=0;
      if(micMode==='vad' && vadOn) gate = voiceActive ? 1 : 0;
    }

    if(gate>0){
      offset += speedPxPerSec * dt * gate;
      applyOffset();
    }
    requestAnimationFrame(loop);
  }
  function applyOffset(){ script.style.transform=`translateY(${-offset}px)`; }

  // SR (–ø–æ —Å–ª–æ–≤–∞–º)
  function initSR(){
    if(!SR) return null;
    const r=new SR(); r.continuous=true; r.interimResults=true; r.lang='ru-RU';
    r.onresult=(ev)=>{
      let final=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ const res=ev.results[i]; if(res.isFinal) final+=' '+res[0].transcript; }
      if(final) handleTranscript(final);
    };
    r.onend=()=>{ if(recogOn){ try{ r.start(); }catch(e){} } };
    r.onerror=(e)=> note('–û—à–∏–±–∫–∞ SR: '+(e.error||'unknown'));
    return r;
  }
  function handleTranscript(text){
    const toks=norm(text).split(' ').filter(Boolean);
    tail.push(...toks); if(tail.length>TAIL) tail=tail.slice(-TAIL);
    for(let k=Math.min(TAIL,5); k>=2; k--){
      const sub=tail.slice(-k);
      const pos=findSubseq(words, sub, currentWord, LOOKAHEAD);
      if(pos>=0){ scrollToWord(pos+k); note('–°–∏–Ω—Ö—Ä–æ–Ω –ø–æ —Å–ª–æ–≤–∞–º ‚úì'); return; }
    }
    const last = tail[tail.length-1];
    if(last){ for(let i=currentWord;i<Math.min(words.length,currentWord+10);i++){ if(words[i]===last){ scrollToWord(i+1); note('–°–∏–Ω—Ö—Ä–æ–Ω –ø–æ —Å–ª–æ–≤—É ‚úì'); return; } } }
  }
  function findSubseq(arr, sub, start, lookahead){
    const end=Math.min(arr.length-sub.length, start+lookahead);
    for(let i=start;i<=end;i++){ if(arr[i]!==sub[0]) continue; let ok=true; for(let j=1;j<sub.length;j++){ if(arr[i+j]!==sub[j]){ ok=false; break; } } if(ok) return i; }
    return -1;
  }
  function scrollToWord(i){
    i=Math.max(0, Math.min(i, spans.length-1)); currentWord=i; highlight();
    const vr=viewer.getBoundingClientRect(); const rect=spans[i].getBoundingClientRect();
    const target=vr.top+vr.height*0.45; const delta=rect.top-target;
    offset += delta; applyOffset();
  }

  // VAD (–ø–æ –≥–æ–ª–æ—Å–æ–≤–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)
  async function startVAD(){
    if(vadOn) return;
    if(!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia)){ note('VAD –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'); return; }
    try{
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const stream = await navigator.mediaDevices.getUserMedia({audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true }});
      mediaStream = stream;
      const source = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);
      vadOn=true; btnMic.classList.add('primary'); note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω (VAD) –≤–∫–ª—é—á—ë–Ω');
      runVAD();
    }catch(e){
      note('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É (–Ω—É–∂–Ω–æ https –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ)');
    }
  }
  function stopVAD(){
    vadOn=false; voiceActive=false;
    if(vadRaf) cancelAnimationFrame(vadRaf), vadRaf=null;
    try{ mediaStream?.getTracks().forEach(t=>t.stop()); }catch{}
    try{ audioCtx?.close(); }catch{}
    mediaStream=null; audioCtx=null; analyser=null;
    btnMic.classList.remove('primary');
    note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
  }
  function runVAD(){
    const buf = new Uint8Array(analyser.fftSize);
    let smooth = 0;
    const tick=()=>{
      if(!vadOn) return;
      analyser.getByteTimeDomainData(buf);
      let sum=0;
      for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum += v*v; }
      const rms = Math.sqrt(sum/buf.length);
      smooth = smooth*0.9 + rms*0.1;
      if(!voiceActive && smooth>VAD_ON) voiceActive=true;
      else if(voiceActive && smooth<VAD_OFF) voiceActive=false;
      vadRaf = requestAnimationFrame(tick);
    };
    tick();
  }

  // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
  function applyFontNow(){ script.style.fontSize = Math.round(map100(lastFont100, FONT_MIN, FONT_MAX)) + 'px'; }
  function onFontInput(){
    const raw=fontVal.value.trim(); if(raw===''){ note('–†–∞–∑–º–µ—Ä: ‚Ä¶'); return; }
    const n=Number(raw);
    if(Number.isInteger(n) && n>=1 && n<=100){
      lastFont100=n; applyFontNow(); localStorage.setItem('tp_font100', String(lastFont100));
      note('–†–∞–∑–º–µ—Ä: '+lastFont100+' (–ø—Ä–∏–º–µ–Ω—ë–Ω)');
    }
  }
  function onFontBlur(){
    let raw=fontVal.value.trim();
    if(raw===''){ fontVal.value=String(lastFont100); onFontInput(); return; }
    let n=Number(raw); if(!Number.isInteger(n)) n=lastFont100;
    if(n<1)n=1; if(n>100)n=100; fontVal.value=String(n); onFontInput();
  }
  function onSpeedInput(){
    const raw=speedVal.value.trim(); if(raw===''){ note('–°–∫–æ—Ä–æ—Å—Ç—å: ‚Ä¶'); return; }
    const n=Number(raw);
    if(Number.isInteger(n) && n>=1 && n<=100){
      lastSpeed100=n; localStorage.setItem('tp_speed100', String(lastSpeed100));
      note('–°–∫–æ—Ä–æ—Å—Ç—å: '+lastSpeed100+' (–ø—Ä–∏–º–µ–Ω–µ–Ω–∞)');
    }
  }
  function onSpeedBlur(){
    let raw=speedVal.value.trim();
    if(raw===''){ speedVal.value=String(lastSpeed100); onSpeedInput(); return; }
    let n=Number(raw); if(!Number.isInteger(n)) n=lastSpeed100;
    if(n<1)n=1; if(n>100)n=100; speedVal.value=String(n); onSpeedInput();
  }

  btnLoad.onclick=()=>{ const t=src.value.trim(); if(!t){ alert('–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç –Ω–∏–∂–µ.'); return; }
    render(t); localStorage.setItem('tp_script_simple', t); note('–¢–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω'); };
  btnPlay.onclick=()=>{ playing=!playing; btnPlay.textContent=playing?'–ü–∞—É–∑–∞':'–°—Ç–∞—Ä—Ç';
    if(playing){ document.body.classList.add('reading'); requestAnimationFrame(loop); note('–ò–¥—ë—Ç –ø—Ä–æ–∫—Ä—É—Ç–∫–∞'); } else note('–ü–∞—É–∑–∞'); };
  btnReset.onclick=()=>{ playing=false; btnPlay.textContent='–°—Ç–∞—Ä—Ç'; offset=0; applyOffset(); currentWord=0; highlight(); note('–í –Ω–∞—á–∞–ª–æ'); };
  btnRead.onclick=()=> document.body.classList.toggle('reading');
  chkMirror.onchange=()=> viewer.classList.toggle('mirror', chkMirror.checked);

  btnMic.onclick=()=>{
    if(micMode==='sr' && SR){
      if(!recognition) recognition = initSR();
      if(!recogOn){
        try{ recognition.start(); recogOn=true; btnMic.classList.add('primary'); note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω (SR) –≤–∫–ª—é—á—ë–Ω'); }
        catch(e){ note('SR –Ω–µ —Å—Ç–∞—Ä—Ç–∞–Ω—É–ª, –ø–æ–ø—Ä–æ–±—É–π VAD'); }
      } else {
        try{ recognition.stop(); }catch(e){}
        recogOn=false; btnMic.classList.remove('primary'); note('–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
      }
    } else {
      if(!vadOn) startVAD(); else stopVAD();
    }
  };

  fontVal.addEventListener('input', onFontInput);
  fontVal.addEventListener('blur', onFontBlur);
  speedVal.addEventListener('input', onSpeedInput);
  speedVal.addEventListener('blur', onSpeedBlur);

  (function(){
    const savedT=localStorage.getItem('tp_script_simple'); if(savedT){ src.value=savedT; render(savedT); }
    const f100=Number(localStorage.getItem('tp_font100')); if(Number.isInteger(f100)&&f100>=1&&f100<=100){ lastFont100=f100; }
    const s100=Number(localStorage.getItem('tp_speed100')); if(Number.isInteger(s100)&&s100>=1&&s100<=100){ lastSpeed100=s100; }
    fontVal.value=String(lastFont100); speedVal.value=String(lastSpeed100);
    applyFontNow(); note('–ì–æ—Ç–æ–≤–æ');
  })();

  function stopAllMic(){
    if(recogOn){ try{ recognition.stop(); }catch{} recogOn=false; }
    if(vadOn) stopVAD();
    btnMic.classList.remove('primary');
  }
})();
</script>
</body>
</html>
